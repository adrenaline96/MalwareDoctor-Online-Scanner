using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

public partial class Home : System.Web.UI.Page
{
    protected void Page_Load(object sender, EventArgs e)
    {
        Label1.Text = "Browse a file to scan it.";
        Button1.Text = "Scan";
        Label2.Visible = false;
        Label3.Visible = false;
        Label4.Visible = false;
        Label5.Visible = false;
        Button2.Visible = false;
        LinkButton1.Visible = false;
         
        
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        
            if (FileUpload1.HasFile)
            {
                try
                {
                    string filename = Path.GetFileName(FileUpload1.FileName);
                    FileUpload1.SaveAs(Server.MapPath("~/Uploads/") + filename);

                //start vt
                Task<List<String>> resultVT;
               resultVT = VirusTotalEngine.CheckVT(Server.MapPath("~/Uploads/") + filename);

                

                if (resultVT.Result.Contains("Unknown"))
                {

                    Label2.Text = "Unknown";

                }
                else if (resultVT.Result.Contains("Error"))
                {
                    Label2.Text = "Error";
                }
                else
                {

                    int engineCount = 0;
                    int detectionCount = 0;


                    MakeTableHeaderVisible();
                    foreach (String line in resultVT.Result)
                    {
                        if (String.IsNullOrEmpty(line) == false)
                        {
                            engineCount = engineCount + 1;
                        }
                        if (line.Contains("True") == true)
                        {
                            detectionCount = detectionCount + 1;
                        }

                        string[] detectionInfo;
                        detectionInfo = line.Split(new char[] { '/' });

                        
                        var cell1 = new TableCell();
                        var cell2 = new TableCell();
                        var cell3 = new TableCell();
                        var row = new TableRow();
                        cell1.Text = detectionInfo[0];

                        if (detectionInfo[1] == "True")
                        {
                            cell2.Text = "Infected";
                        }
                        else if(detectionInfo[1] == "False")
                        {
                            cell2.Text = "Clean";
                        }
  
                        cell3.Text = detectionInfo[2];
                        row.Cells.Add(cell1);
                        row.Cells.Add(cell2);
                        row.Cells.Add(cell3);
                       
                        Table1.Rows.Add(row);
                    }


                    Label2.Text = Label2.Text + detectionCount.ToString() + "/" + engineCount.ToString();

                }
                //end vt

                String resultMD = MDEngine.CheckMalc0de(MDEngine.GetMD5(Server.MapPath("~/Uploads/") + filename));
                String resultVX = MDEngine.CheckVXVault(MDEngine.GetMD5(Server.MapPath("~/Uploads/") + filename));

                Label3.Text = Label3.Text + resultMD;
                Label4.Text = Label4.Text + resultVX;
                Label5.Text = "Results for " + filename + " (MD5:" + MDEngine.GetMD5(Server.MapPath("~/Uploads/") + filename)+")";


                UnhideControls();
            }
                catch (Exception ex)
                {
                Label5.Text = ex.Message;
                   
                }
            }
        
    }

    public void UnhideControls()
    {
        Label2.Visible = true;
        Label3.Visible = true;
        Label4.Visible = true;
        Label5.Visible = true;
        Button2.Visible = true;
        LinkButton1.Visible = true;
    }
    protected void Button2_Click(object sender, EventArgs e)
    {
        
            Table1.Visible = true;
        
        
    }
    

    public void MakeTableHeaderVisible()
    {
        TableHeaderCell headerTableCell1 = new TableHeaderCell();
        TableHeaderCell headerTableCell2 = new TableHeaderCell();
        TableHeaderCell headerTableCell3 = new TableHeaderCell();

        headerTableCell1.Text = "Engine";
        headerTableCell2.Text = "Verdict";
        headerTableCell3.Text = "Detection";

        TableHeaderRow headerRow = new TableHeaderRow();
        headerRow.Cells.Add(headerTableCell1);
        headerRow.Cells.Add(headerTableCell2);
        headerRow.Cells.Add(headerTableCell3);
        Table1.Rows.Add(headerRow);
    }
}